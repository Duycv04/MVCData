@model MVCData.Models.NhanVien
<form id="createStaffForm" class="container-fluid px-2 px-md-4">
    <div class="row g-3">
        <div class="col-12 col-md-6">
            <label class="form-label">Họ tên</label>
            <input asp-for="HoTen" class="form-control" />
            <span id="errHoTen" class="text-danger small"></span>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Ngày sinh</label>
            <input asp-for="NgaySinh" type="date" class="form-control" />
            <span id="errNgaySinh" class="text-danger small"></span>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Số điện thoại</label>
            <input asp-for="SoDienThoai" class="form-control" />
            <span id="errSoDienThoai" class="text-danger small"></span>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Số năm công tác</label>
            <input asp-for="SoNamCongTac" type="number" min="0" class="form-control" />
        </div>
        <div class="col-12 ">
            <label class="form-label">Địa chỉ</label>
            <input asp-for="DiaChi" class="form-control" list="diaChiList" placeholder="Nhập hoặc chọn địa chỉ" />
            <datalist id="diaChiList">
                <option value="Hà Nội"></option>
                <option value="TP Hồ Chí Minh"></option>
                <option value="Đà Nẵng"></option>
                <option value="Cần Thơ"></option>
                <option value="Hải Phòng"></option>
                <option value="Bình Dương"></option>
                <option value="Đồng Nai"></option>
            </datalist>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Chức vụ</label>
            <input asp-for="ChucVu" class="form-control" list="ChucVuList" placeholder="Nhập hoặc chọn chức vụ" />
            <datalist id="ChucVuList">
                <option value="Giám Đốc"></option>
                <option value="Phó Giám Đốc"></option>
                <option value="Trưởng phòng"></option>
                <option value="Trưởng Nhóm"></option>
                <option value="Kế Toán"></option>
                <option value="Nhân viên"></option>
                <option value="Thực tập sinh"></option>
            </datalist>
        </div>
        <div class="col-12 col-md-6">
            <label class="form-label">Phòng ban</label>
            <select asp-for="PhongBanId" class="form-select">
                <option value="">Chọn phòng ban</option>
                @foreach (dynamic pb in ViewBag.PhongBans)
                {
                    <option value="@pb.ID">@pb.TenPhongBan</option>
                }
            </select>
        </div>
        <div class="col-12 text-end">
            <button type="submit" id="btnSave" class="btn btn-success w-100 w-md-auto">
                Lưu
            </button>
        </div>
    </div>
</form>
<script>
    $(function () {
        function checkNgaySinh() {
            let ngaySinh = $("#NgaySinh").val();
            let today = new Date().toISOString().split("T")[0];

            if (!ngaySinh) {
                $("#errNgaySinh").text("Vui lòng nhập ngày sinh");
                return false;
            }

            if (ngaySinh >= today) {
                $("#errNgaySinh").text("Ngày sinh phải nhỏ hơn ngày hiện tại");
                return false;
            }
            $("#errNgaySinh").text("");
            return true;
        }
        function checkHoTen() {
            let hoTen = $("#HoTen").val().trim();
            if (hoTen.length < 2) {
                $("#errHoTen").text("Họ tên phải có ít nhất 2 ký tự");
                return false;
            }
            $("#errHoTen").text("");
            return true;
        }

        function checkSoNamCongTac() {
            let val = $("#SoNamCongTac").val();
            if (val === "" || isNaN(val) || parseInt(val) < 0) {
                alert("Số năm công tác phải là số >= 0");
                return false;
            }
            return true;
        }

        function checkDiaChi() {
            let diaChi = $("#DiaChi").val().trim();
            if (diaChi === "") {
                alert("Vui lòng nhập địa chỉ");
                return false;
            }
            return true;
        }

        function checkChucVu() {
            let chucVu = $("#ChucVu").val().trim();
            if (chucVu === "") {
                alert("Vui lòng nhập chức vụ");
                return false;
            }
            return true;
        }

        function checkPhongBan() {
            let pb = $("#PhongBanId").val();
            if (!pb) {
                alert("Vui lòng chọn phòng ban");
                return false;
            }
            return true;
        }
        function checkSoDienThoai() {
            let soDienThoai = $("#SoDienThoai").val().trim();
            let regex = /^0\d{9}$/;

            $("#errSoDienThoai").text("");

            if (soDienThoai === "") {
                $("#errSoDienThoai").text("Vui lòng nhập số điện thoại");
                return false;
            }

            if (!regex.test(soDienThoai)) {
                $("#errSoDienThoai").text("Số điện thoại phải gồm 10 số và bắt đầu bằng 0");
                return false;
            }
            let isValid = false;

            $.ajax({
                url: "/Staff/CheckSDT",
                type: "GET",
                data: { soDienThoai: soDienThoai },
                async: false,
                success: function (res) {
                    if (res === true) {
                        $("#errSoDienThoai").text("Số điện thoại đã tồn tại");
                        isValid = false;
                    } else {
                        isValid = true;
                    }
                },
                error: function () {
                    $("#errSoDienThoai").text("Không kiểm tra được số điện thoại");
                    isValid = false;
                }
            });
            return isValid;
        }
        function checkTrungNhanVien(callback) {
            let hoTen = $("#HoTen").val();
            let ngaySinh = $("#NgaySinh").val();

            if (!hoTen || !ngaySinh) {
                callback(true);
                return;
            }
            $.get("/Staff/KiemTraTrung",
                { hoTen: hoTen, ngaySinh: ngaySinh },
                function (isValid) {
                    if (!isValid) {
                        $("#errHoTen").text("Nhân viên này đã tồn tại!");
                        callback(false);
                    } else {
                        $("#errHoTen").text("");
                        callback(true);
                    }
                }
            );
        }
        $("#NgaySinh").on("change", checkNgaySinh);
        $("#SoDienThoai").on("blur", checkSoDienThoai);
        $("#HoTen, #NgaySinh").on("blur change", function () {
            if (checkNgaySinh()) {
                checkTrungNhanVien(function () { });
            }
        });
        $("#btnSave").on("click", function () {

            if (!checkHoTen()) return;
            if (!checkNgaySinh()) return;
            if (!checkSoNamCongTac()) return;
            if (!checkDiaChi()) return;
            if (!checkChucVu()) return;
            if (!checkPhongBan()) return;

            let isSoDTValid = checkSoDienThoai();
            if (!isSoDTValid) return;

            checkTrungNhanVien(function (isValid) {
                if (!isValid) return;

                let form = $("#createStaffForm");
                $.ajax({
                    url: "/Staff/CreatePopup",
                    type: "POST",
                    data: form.serialize(),
                    beforeSend: function () {
                        $("#btnSave").prop("disabled", true);
                    },
                    success: function (res) {
                        if (res.success) {
                            $("#createStaffModal").modal("hide");
                            location.reload();
                        } else {
                            $("#createStaffContent").html(res);
                        }
                    },
                    error: function () {
                        alert("Có lỗi xảy ra khi lưu nhân viên!");
                    },
                    complete: function () {
                        $("#btnSave").prop("disabled", false);
                    }
                });
            });
        });
    });
</script>